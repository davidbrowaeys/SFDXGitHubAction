- name: ðŸ” Determine Target Environment & Mode
        id: set_targets
        run: |
          # --- Define Variables from GitHub Context ---
          EVENT_NAME="${{ github.event_name }}"
          BASE_REF="${{ github.base_ref }}"
          REF="${{ github.ref }}"
          
          targets="[]"
          
          # --- Determine Check-Only Mode ---
          CHECK_ONLY_MODE="false"
          if [ "$EVENT_NAME" = "pull_request" ]; then
            CHECK_ONLY_MODE="true"
          fi
          
          echo "Deployment Mode: Check-Only = $CHECK_ONLY_MODE"
          
          # --- SCENARIO A: Target is 'develop' (SIT environment) ---
          if [ "$BASE_REF" = "develop" ] || [ "$REF" = "refs/heads/develop" ]; then
            echo "Target branch is 'develop'. Scheduling SIT validation/deployment."
            
            targets=$(echo "$targets" | jq '. += [{
              "target_env": "SIT",  
              "auth_secret": "SIT_AUTH_URL",
              "check_only": '$CHECK_ONLY_MODE'
            }]')
            
          # --- SCENARIO B: Target is a 'release/**' branch (QA environment) ---
          elif [[ "$BASE_REF" =~ ^release/ ]] || [[ "$REF" =~ refs/heads/release/ ]]; then
            echo "Target branch is a 'release/**' branch. Targeting QA environments."

            # Proxy Rule: PR/Push to Release branch triggers both QA1 and QA2
            
            # QA1 Target
            targets=$(echo "$targets" | jq '. += [{
              "target_env": "QA1",  
              "auth_secret": "QA1_AUTH_URL",
              "check_only": '$CHECK_ONLY_MODE'
            }]')
            
            # QA2 Target
            targets=$(echo "$targets" | jq '. += [{
              "target_env": "QA2",  
              "auth_secret": "QA2_AUTH_URL",
              "check_only": '$CHECK_ONLY_MODE'
            }]')

          else
            echo "::notice::Workflow triggered by event/branch that does not require deployment. Exiting."
          fi

          # -----------------------------------------------------------------
          # CRITICAL FIX FOR MULTILINE JSON OUTPUT
          # -----------------------------------------------------------------
          
          # Check if the targets array is empty
          if [ "$targets" = "[]" ]; then
            echo "::notice::No relevant deployment conditions met. Terminating workflow early."
            # Setting an empty string output, then exiting 1 to prevent downstream jobs.
            echo "targets='[]'" >> $GITHUB_OUTPUT
            exit 1
          fi

          # 1. Define EOL delimiter
          DELIMITER=$(uuidgen)
          
          echo "Targets JSON: $targets"
          
          # 2. Start multi-line output with the delimiter
          echo "targets<<$DELIMITER" >> $GITHUB_OUTPUT
          
          # 3. Output the JSON array
          echo "$targets" >> $GITHUB_OUTPUT
          
          # 4. End multi-line output with the delimiter
          echo "$DELIMITER" >> $GITHUB_OUTPUT
          
        shell: bash
