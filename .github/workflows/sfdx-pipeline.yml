name: Salesforce Multi-Environment Pipeline

on:
  pull_request:
    branches:
      - develop
      - 'release/**'
  push:
    branches:
      - develop
      - 'release/**'

jobs:
  # ----------------------------------------------------
  # ðŸ”‘ Global Helper: Determine Comparison Branches (Standard Job)
  # ----------------------------------------------------
  set_comparison_vars:
    runs-on: ubuntu-latest
    outputs:
      compare_branch: ${{ steps.compare.outputs.branch }}
    steps:
      - id: compare
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "::set-output name=branch::${{ github.base_ref }}"
          else
            echo "::set-output name=branch::HEAD^"
          fi
        shell: bash

  # ====================================================
  # QA STAGE (Validation & Deployment)
  # ====================================================

  # 1. QA Validation Trigger (Standard Job)
  qa_validation_pr_trigger:
    runs-on: ubuntu-latest # Required for the parser
    needs: set_comparison_vars
    if: github.event_name == 'pull_request' && github.base_ref == 'develop'
    outputs:
      compare_branch: ${{ needs.set_comparison_vars.outputs.compare_branch }}
    steps:
      - run: echo "Triggering QA Validation..."
  
  # 1. QA Validation Call (Reusable Workflow Job)
  qa_validation_pr:
    name: ðŸ§ª QA Validation (PR)
    needs: qa_validation_pr_trigger
    # The 'if' and 'environment' logic is handled by the trigger job
    uses: davidbrowaeys/SafireForGitHub/.github/workflows/continuous-integration.yml@main
    with:
      target-env: 'qa'
      deployment-mode: 'DELTA'
      test-level: 'RunLocalTests'
      check-only: true
      compare-with: ${{ needs.qa_validation_pr_trigger.outputs.compare_branch }}
    secrets:
      auth-url-secret-name: SF_QA_AUTH_URL 
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # 2. QA Deployment Trigger (Standard Job)
  qa_deployment_trigger:
    runs-on: ubuntu-latest # Required for the parser
    needs: set_comparison_vars
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    outputs:
      compare_branch: ${{ needs.set_comparison_vars.outputs.compare_branch }}
    steps:
      - run: echo "Triggering QA Deployment..."

  # 2. QA Deployment Call (Reusable Workflow Job)
  qa_deployment:
    name: ðŸš€ QA Deployment (Push)
    needs: qa_deployment_trigger
    uses: davidbrowaeys/SafireForGitHub/.github/workflows/continuous-integration.yml@main
    with:
      target-env: 'qa' 
      deployment-mode: 'DELTA'
      test-level: 'RunLocalTests'
      check-only: false 
      compare-with: ${{ needs.qa_deployment_trigger.outputs.compare_branch }}
    secrets:
      auth-url-secret-name: SF_QA_AUTH_URL 
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ====================================================
  # SIT STAGE (Validation & Deployment)
  # ====================================================

  # 3. SIT Validation Trigger (Standard Job)
  sit_validation_pr_trigger:
    runs-on: ubuntu-latest
    needs: set_comparison_vars
    if: github.event_name == 'pull_request' && startsWith(github.base_ref, 'release/')
    environment: SIT # Environment must be on the standard job
    outputs:
      compare_branch: ${{ needs.set_comparison_vars.outputs.compare_branch }}
    steps:
      - run: echo "Triggering SIT Validation..."

  # 3. SIT Validation Call (Reusable Workflow Job)
  sit_validation_pr:
    name: ðŸ”¬ SIT Validation (Release PR)
    needs: sit_validation_pr_trigger
    uses: davidbrowaeys/SafireForGitHub/.github/workflows/continuous-integration.yml@main
    with:
      target-env: 'sit'
      deployment-mode: 'DELTA'
      test-level: 'RunLocalTests'
      check-only: true
      compare-with: ${{ needs.sit_validation_pr_trigger.outputs.compare_branch }}
    secrets:
      auth-url-secret-name: SF_SIT_AUTH_URL
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # 4. SIT Deployment Trigger (Standard Job)
  sit_deployment_trigger:
    runs-on: ubuntu-latest
    needs: set_comparison_vars
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/heads/release/')
    environment: SIT # Environment must be on the standard job
    outputs:
      compare_branch: ${{ needs.set_comparison_vars.outputs.compare_branch }}
    steps:
      - run: echo "Triggering SIT Deployment..."

  # 4. SIT Deployment Call (Reusable Workflow Job)
  sit_deployment:
    name: ðŸš€ SIT Deployment (Release Push)
    needs: sit_deployment_trigger
    uses: davidbrowaeys/SafireForGitHub/.github/workflows/continuous-integration.yml@main
    with:
      target-env: 'sit'
      deployment-mode: 'DELTA'
      test-level: 'RunLocalTests'
      check-only: false
      compare-with: ${{ needs.sit_deployment_trigger.outputs.compare_branch }}
    secrets:
      auth-url-secret-name: SF_SIT_AUTH_URL
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      
  # ====================================================
  # UAT STAGE (Validation & Deployment)
  # ====================================================

  # 5. UAT Validation Trigger (Standard Job)
  uat_validation_trigger:
    runs-on: ubuntu-latest
    needs: sit_deployment
    if: always() && needs.sit_deployment.result == 'success'
    environment: UAT # Environment must be on the standard job (triggers approval)
    outputs:
      compare_branch: 'HEAD^'
    steps:
      - run: echo "Triggering UAT Validation..."

  # 5. UAT Validation Call (Reusable Workflow Job)
  uat_validation:
    name: âœ… UAT Validation (Manual Approval)
    needs: uat_validation_trigger
    uses: davidbrowaeys/SafireForGitHub/.github/workflows/continuous-integration.yml@main
    with:
      target-env: 'uat'
      deployment-mode: 'FULL'
      test-level: 'RunAllTestsInOrg'
      check-only: true
      compare-with: ${{ needs.uat_validation_trigger.outputs.compare_branch }}
    secrets:
      auth-url-secret-name: SF_UAT_AUTH_URL
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # 6. UAT Deployment Trigger (Standard Job)
  uat_deployment_trigger:
    runs-on: ubuntu-latest
    needs: uat_validation
    if: always() && needs.uat_validation.result == 'success'
    environment: UAT # Environment must be on the standard job (triggers approval)
    outputs:
      compare_branch: 'HEAD^'
    steps:
      - run: echo "Triggering UAT Deployment..."

  # 6. UAT Deployment Call (Reusable Workflow Job)
  uat_deployment:
    name: ðŸš€ UAT Deployment (Manual Approval)
    needs: uat_deployment_trigger
    uses: davidbrowaeys/SafireForGitHub/.github/workflows/continuous-integration.yml@main
    with:
      target-env: 'uat'
      deployment-mode: 'DELTA'
      test-level: 'RunAllTestsInOrg'
      check-only: false
      compare-with: ${{ needs.uat_deployment_trigger.outputs.compare_branch }}
    secrets:
      auth-url-secret-name: SF_UAT_AUTH_URL
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      
  # ====================================================
  # PROD STAGE (Validation & Deployment)
  # ====================================================

  # 7. Prod Validation Trigger (Standard Job)
  prod_validation_trigger:
    runs-on: ubuntu-latest
    needs: uat_deployment
    if: always() && needs.uat_deployment.result == 'success'
    environment: Production # Environment must be on the standard job (triggers approval)
    outputs:
      compare_branch: 'HEAD^'
    steps:
      - run: echo "Triggering Prod Validation..."

  # 7. Prod Validation Call (Reusable Workflow Job)
  prod_validation:
    name: âœ… Prod Validation (Manual Approval)
    needs: prod_validation_trigger
    uses: davidbrowaeys/SafireForGitHub/.github/workflows/continuous-integration.yml@main
    with:
      target-env: 'prod'
      deployment-mode: 'FULL' 
      test-level: 'RunAllTestsInOrg' 
      check-only: true
      compare-with: ${{ needs.prod_validation_trigger.outputs.compare_branch }}
    secrets:
      auth-url-secret-name: SF_PROD_AUTH_URL
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # 8. Prod Deployment Trigger (Standard Job)
  prod_deployment_trigger:
    runs-on: ubuntu-latest
    needs: prod_validation
    if: always() && needs.prod_validation.result == 'success'
    environment: Production # Environment must be on the standard job (triggers approval)
    outputs:
      compare_branch: 'HEAD^'
    steps:
      - run: echo "Triggering Prod Deployment..."

  # 8. Prod Deployment Call (Reusable Workflow Job)
  prod_deployment:
    name: ðŸ‘‘ Prod Deployment (Manual Approval)
    needs: prod_deployment_trigger
    uses: davidbrowaeys/SafireForGitHub/.github/workflows/continuous-integration.yml@main
    with:
      target-env: 'prod'
      deployment-mode: 'DELTA'
      test-level: 'RunAllTestsInOrg'
      check-only: false 
      compare-with: ${{ needs.prod_deployment_trigger.outputs.compare_branch }}
    secrets:
      auth-url-secret-name: SF_PROD_AUTH_URL
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
