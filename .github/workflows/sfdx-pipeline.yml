name: Salesforce Multi-Environment Pipeline

on:
  # 1. Feature -> Develop PR (Validation for QA)
  pull_request:
    branches:
      - develop
  # 2. Develop -> Release PR (Validation for SIT)
      - release/**
  # 3. Push to Develop (Deployment to QA)
  push:
    branches:
      - develop
  # 4. Push to Release (Deployment to SIT, UAT, Prod)
      - release/**

# Global default inputs for the reusable workflow
env:
  # Default delta comparison branch for pushes
  DEFAULT_COMPARE_PUSH: 'HEAD^' 
  # Default delta comparison branch for pull requests
  DEFAULT_COMPARE_PR: ${{ github.base_ref }}

jobs:
  # ----------------------------------------------------
  # STEP 1: Feature -> Develop PR (QA Validation)
  # Runs when any branch creates a PR targeting 'develop'
  # ----------------------------------------------------
  qa_validation_pr:
    name: ðŸ§ª QA Validation (PR)
    if: github.event_name == 'pull_request' && github.base_ref == 'develop'
    uses: davidbrowaeys/SafireForGitHub/.github/workflows/continuous-integration.yml@main
    
    with:
      target-env: 'qa' 
      deployment-mode: 'DELTA'
      test-level: 'RunLocalTests'
      check-only: true
      compare-with: ${{ env.DEFAULT_COMPARE_PR }}
    
    secrets:
      auth-url-secret-name: SF_QA_AUTH_URL 
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      
  # ----------------------------------------------------
  # STEP 2: Push to Develop (QA Deployment)
  # Runs after the PR is merged into 'develop'
  # ----------------------------------------------------
  qa_deployment:
    name: ðŸš€ QA Deployment (Push)
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    # Wait for the PR validation to pass if run manually
    needs: qa_validation_pr
    uses: davidbrowaeys/SafireForGitHub.github/workflows/continuous-integration.yml@main
    
    with:
      target-env: 'qa' 
      deployment-mode: 'DELTA'
      test-level: 'RunLocalTests'
      check-only: false # Actual deployment
      compare-with: ${{ env.DEFAULT_COMPARE_PUSH }}
    
    secrets:
      auth-url-secret-name: SF_QA_AUTH_URL 
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      
  # ----------------------------------------------------
  # STEP 3: Develop -> Release PR (SIT Validation)
  # Runs when the 'develop' branch creates a PR targeting 'release/r1.0'
  # ----------------------------------------------------
  sit_validation_pr:
    name: ðŸ”¬ SIT Validation (Release PR)
    # Check if this is a PR targeting a branch starting with 'release/'
    if: github.event_name == 'pull_request' && startsWith(github.base_ref, 'release/')
    # This job should use the SIT Environment (no approval needed for validation)
    environment: SIT
    uses: davidbrowaeys/SafireForGitHub/.github/workflows/continuous-integration.yml@main
    
    with:
      target-env: 'sit'
      deployment-mode: 'DELTA'
      test-level: 'RunLocalTests'
      check-only: true
      compare-with: ${{ env.DEFAULT_COMPARE_PR }}
      
    secrets:
      auth-url-secret-name: SF_SIT_AUTH_URL
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ----------------------------------------------------
  # STEP 4: Push to Release (SIT Deployment)
  # Runs after the 'develop' PR is merged into the 'release' branch
  # ----------------------------------------------------
  sit_deployment:
    name: ðŸš€ SIT Deployment (Release Push)
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/heads/release/')
    needs: sit_validation_pr
    # This job deploys to the SIT Environment
    environment: SIT
    uses: davidbrowaeys/SafireForGitHub/.github/workflows/continuous-integration.yml@main
    
    with:
      target-env: 'sit'
      deployment-mode: 'DELTA'
      test-level: 'RunLocalTests'
      check-only: false # Actual deployment
      compare-with: ${{ env.DEFAULT_COMPARE_PUSH }}
      
    secrets:
      auth-url-secret-name: SF_SIT_AUTH_URL
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ----------------------------------------------------
  # STEP 5: UAT Validation (Manual Approval Required)
  # Runs immediately after SIT deployment, but waits for approval
  # ----------------------------------------------------
  uat_validation:
    name: âœ… UAT Validation (Manual Approval)
    if: success()
    needs: sit_deployment
    # Use the UAT Environment, which requires reviewers in Settings
    environment: UAT
    uses: davidbrowaeys/SafireForGitHub/.github/workflows/continuous-integration.yml@main
    
    with:
      target-env: 'uat'
      deployment-mode: 'FULL' # Optional: Run full validation here
      test-level: 'RunAllTestsInOrg' # Optional: Run all tests here
      check-only: true # Always Validation for this first step
      compare-with: ${{ env.DEFAULT_COMPARE_PUSH }} # The release branch is being compared to its previous state
      
    secrets:
      auth-url-secret-name: SF_UAT_AUTH_URL
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ----------------------------------------------------
  # STEP 6: UAT Deployment (Manual Approval Required)
  # Runs only if UAT Validation is successful and approved
  # ----------------------------------------------------
  uat_deployment:
    name: ðŸš€ UAT Deployment (Manual Approval)
    if: success()
    needs: uat_validation
    # Use the UAT Environment, which requires reviewers in Settings
    environment: UAT
    uses: davidbrowaeys/SafireForGitHub/continuous-integration.yml@main
    
    with:
      target-env: 'uat'
      deployment-mode: 'DELTA'
      test-level: 'RunAllTestsInOrg'
      check-only: false # Actual deployment
      compare-with: ${{ env.DEFAULT_COMPARE_PUSH }} 
      
    secrets:
      auth-url-secret-name: SF_UAT_AUTH_URL
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ----------------------------------------------------
  # STEP 7: Prod Validation (Manual Approval Required)
  # Runs only if UAT deployment is successful
  # ----------------------------------------------------
  prod_validation:
    name: âœ… Prod Validation (Manual Approval)
    if: success()
    needs: uat_deployment
    # Use the Production Environment, which requires reviewers in Settings
    environment: Production
    uses: davidbrowaeys/SafireForGitHub/.github/workflows/continuous-integration.yml@main
    
    with:
      target-env: 'prod'
      deployment-mode: 'FULL' # Full validation is highly recommended for prod
      test-level: 'RunAllTestsInOrg' 
      check-only: true # Always Validation for this first step
      compare-with: ${{ env.DEFAULT_COMPARE_PUSH }}
      
    secrets:
      auth-url-secret-name: SF_PROD_AUTH_URL
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ----------------------------------------------------
  # STEP 8: Prod Deployment (Manual
