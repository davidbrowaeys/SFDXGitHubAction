name: Salesforce Project CI/CD

on:
  pull_request:
    # Triggers on PRs targeting develop or any release branch
    branches:
      - develop
      - 'release/**'
  push:
    # Triggers on Pushes directly to develop or any release branch
    branches:
      - develop
      - 'release/**'

jobs:
  # --- 1. Determine which environments need validation/deployment ---
  determine_targets:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set_targets.outputs.targets }}
      
    steps:
      - name: ðŸ” Determine Target Environment & Mode
        id: set_targets
        run: |
          EVENT_NAME="${{ github.event_name }}"
          BASE_REF="${{ github.base_ref }}"
          REF="${{ github.ref }}"
          
          # Initialize $target_config as an empty string/null to signal no deployment
          TARGET_CONFIG="" 
          
          CHECK_ONLY_MODE="false"
          if [ "$EVENT_NAME" = "pull_request" ]; then
            CHECK_ONLY_MODE="true"
          fi
          
          JQ_OPTIONS='-c --arg checkmode "$CHECK_ONLY_MODE"'
          
          # -----------------------------------------------------------------
          # PRIORITY 1: Target is 'develop' (Shared QA/SIT)
          # This should run first as it represents the highest integration level.
          # -----------------------------------------------------------------
          if [ "$BASE_REF" = "develop" ] || [ "$REF" = "refs/heads/develop" ]; then
            echo "Target branch is 'develop'. Scheduling QA validation/deployment."
            
            # Set $TARGET_CONFIG to a single JSON object (no array brackets)
            TARGET_CONFIG=$(echo "{}" | jq $JQ_OPTIONS '. += { 
              "target_env": "QA",  
              "auth_secret": "QA_AUTH_URL",
              "check_only": $checkmode
            }')
            
          # -----------------------------------------------------------------
          # PRIORITY 2: Target is a 'release/**' branch (QA1 or QA2 - Single Choice)
          # We must decide which QA to pick, or default to one.
          # For simplicity, we will deploy to QA1 as the primary release QA.
          # -----------------------------------------------------------------
          elif [[ "$BASE_REF" =~ ^release/ ]] || [[ "$REF" =~ refs/heads/release/ ]]; then
            echo "Target branch is a 'release/**' branch. Scheduling QA1 validation/deployment."

            TARGET_CONFIG=$(echo "{}" | jq $JQ_OPTIONS '. += {
              "target_env": "QA1",  
              "auth_secret": "QA1_AUTH_URL",
              "check_only": $checkmode
            }')

          else
            echo "::notice::Workflow triggered by event/branch that does not require deployment."
          fi

          # -----------------------------------------------------------------
          # Final Output Processing
          # -----------------------------------------------------------------
          
          # Check if a target was set
          if [ -z "$TARGET_CONFIG" ]; then
            echo "::notice::No relevant deployment conditions met. Exiting job."
            # Set a default null output and exit 0 (allow subsequent job to skip)
            echo "target_config={}" >> $GITHUB_OUTPUT
            exit 0
          fi

          # 1. Use 'jq -c' to output the JSON compacted to a single line.
          COMPACT_CONFIG=$(echo "$TARGET_CONFIG" | jq -c '.')
          echo "Target Configuration (Compacted): $COMPACT_CONFIG"
          
          # 2. Output the single-line string directly to GITHUB_OUTPUT.
          echo "target_config=$COMPACT_CONFIG" >> $GITHUB_OUTPUT
        shell: bash

  # --- 2. Main Job: Execute Deployments Dynamically (Matrix) ---
  qa_validation_pr:
    name: ðŸš€ Deploy to ${{ matrix.target.target_env }} (${{ matrix.target.check_only == 'true' && 'Validation' || 'Deployment' }})
    needs: determine_targets
    
    uses: davidbrowaeys/SafireForGitHub/.github/workflows/continuous-integration.yml@main
    
    with:
      # Access config values directly via the 'target' object
      target-env: ${{ fromJson(needs.determine_targets.outputs.target_config).target_env }}
      deployment-mode: 'DELTA'
      
      check-only: ${{ fromJson(needs.determine_targets.outputs.target_config).check_only == 'true' }}
      run-code-scanner: ${{ fromJson(needs.determine_targets.outputs.target_config).check_only == 'true' }}
      
    secrets:
      # Access secret key name directly via the 'target' object
      AUTH_URL: ${{ secrets[matrix.target.auth_secret] }}
