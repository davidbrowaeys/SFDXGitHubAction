name: Salesforce Multi-Environment Pipeline

on:
  pull_request:
    branches:
      - develop
      - 'release/**'
  push:
    branches:
      - develop
      - 'release/**'

jobs:
  # ----------------------------------------------------
  # ðŸ”‘ Global Helper: Determine Comparison Branches
  # This job runs first to determine dynamic compare values
  # ----------------------------------------------------
  set_comparison_vars:
    runs-on: ubuntu-latest
    outputs:
      # Compare with: HEAD^ for push, base_ref for pull_request
      compare_branch: ${{ steps.compare.outputs.branch }}
    steps:
      - id: compare
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # For PR, compare with the target branch
            echo "::set-output name=branch::${{ github.base_ref }}"
          else
            # For Push, compare with the previous commit
            echo "::set-output name=branch::HEAD^"
          fi
        shell: bash

  # ----------------------------------------------------
  # STEP 1: Feature -> Develop PR (QA Validation)
  # ----------------------------------------------------
  qa_validation_pr:
    name: ðŸ§ª QA Validation (PR)
    needs: set_comparison_vars
    if: github.event_name == 'pull_request' && github.base_ref == 'develop'
    
    # Correct structure: 'uses' is the top-level property under the job ID
    uses: davidbrowaeys/SafireForGitHub/.github/workflows/continuous-integration.yml@main
    
    # 'with' and 'secrets' are correctly nested under 'uses' job
    with:
      target-env: 'qa'
      deployment-mode: 'DELTA'
      test-level: 'RunLocalTests'
      check-only: true
      # Correctly referencing the output from the set_comparison_vars job
      compare-with: ${{ needs.set_comparison_vars.outputs.compare_branch }}
    
    secrets:
      auth-url-secret-name: SF_QA_AUTH_URL 
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      
  # ----------------------------------------------------
  # STEP 2: Push to Develop (QA Deployment)
  # ----------------------------------------------------
  qa_deployment:
    name: ðŸš€ QA Deployment (Push)
    needs: [set_comparison_vars, qa_validation_pr]
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    
    uses: davidbrowaeys/SafireForGitHub/.github/workflows/continuous-integration.yml@main
    
    with:
      target-env: 'qa' 
      deployment-mode: 'DELTA'
      test-level: 'RunLocalTests'
      check-only: false 
      compare-with: ${{ needs.set_comparison_vars.outputs.compare_branch }}
    
    secrets:
      auth-url-secret-name: SF_QA_AUTH_URL 
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      
  # ----------------------------------------------------
  # STEP 3: Develop -> Release PR (SIT Validation)
  # ----------------------------------------------------
  sit_validation_pr:
    name: ðŸ”¬ SIT Validation (Release PR)
    needs: set_comparison_vars
    if: github.event_name == 'pull_request' && startsWith(github.base_ref, 'release/')
    environment: SIT
    
    uses: davidbrowaeys/SafireForGitHub/.github/workflows/continuous-integration.yml@main
    
    with:
      target-env: 'sit'
      deployment-mode: 'DELTA'
      test-level: 'RunLocalTests'
      check-only: true
      compare-with: ${{ needs.set_comparison_vars.outputs.compare_branch }}
      
    secrets:
      auth-url-secret-name: SF_SIT_AUTH_URL
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ----------------------------------------------------
  # STEP 4: Push to Release (SIT Deployment)
  # ----------------------------------------------------
  sit_deployment:
    name: ðŸš€ SIT Deployment (Release Push)
    needs: [set_comparison_vars, sit_validation_pr]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/heads/release/')
    environment: SIT
    
    uses: davidbrowaeys/SafireForGitHub/.github/workflows/continuous-integration.yml@main
    
    with:
      target-env: 'sit'
      deployment-mode: 'DELTA'
      test-level: 'RunLocalTests'
      check-only: false
      compare-with: ${{ needs.set_comparison_vars.outputs.compare_branch }}
      
    secrets:
      auth-url-secret-name: SF_SIT_AUTH_URL
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ----------------------------------------------------
  # STEP 5: UAT Validation (Manual Approval Required)
  # ----------------------------------------------------
  uat_validation:
    name: âœ… UAT Validation (Manual Approval)
    needs: sit_deployment
    if: always() && needs.sit_deployment.result == 'success'
    environment: UAT
    
    uses: davidbrowaeys/SafireForGitHub/.github/workflows/continuous-integration.yml@main
    
    with:
      target-env: 'uat'
      deployment-mode: 'FULL'
      test-level: 'RunAllTestsInOrg'
      check-only: true
      compare-with: 'HEAD^' # Compare the release branch against its previous state
      
    secrets:
      auth-url-secret-name: SF_UAT_AUTH_URL
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ----------------------------------------------------
  # STEP 6: UAT Deployment (Manual Approval Required)
  # ----------------------------------------------------
  uat_deployment:
    name: ðŸš€ UAT Deployment (Manual Approval)
    needs: uat_validation
    if: always() && needs.uat_validation.result == 'success'
    environment: UAT
    
    uses: davidbrowaeys/SafireForGitHub/.github/workflows/continuous-integration.yml@main
    
    with:
      target-env: 'uat'
      deployment-mode: 'DELTA'
      test-level: 'RunAllTestsInOrg'
      check-only: false
      compare-with: 'HEAD^' 
      
    secrets:
      auth-url-secret-name: SF_UAT_AUTH_URL
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
